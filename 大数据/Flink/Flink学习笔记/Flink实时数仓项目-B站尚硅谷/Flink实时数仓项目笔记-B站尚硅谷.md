# Flink实时数仓项目笔记

> Flnk实时项目

# 1.采集模块

## 1.1数仓分层

### 1.1.1 数仓为什么要分层

> 复用

1. 普通实时计算优**先考虑时效性**，所以从数据源采集经过实时计算直接得到结果，时效性好。 但是弊端是由于计算过程中的中间结果没有沉淀下来，所以当面对大量实时需求时，计算的复用性差，开发成本随着需求增加而直线上升

   ![image-20220704075825629](https://tva1.sinaimg.cn/large/e6c9d24egy1h3ukekzcayj20vg0a0jss.jpg)

2. 实时数仓基于一定的数仓理念，对数处理流程进行**规划，分层**，目的就是为了数据的**复用性**。

   ![image-20220704075915054](https://tva1.sinaimg.cn/large/e6c9d24egy1h3ukfc5n6lj20ve0bs0u2.jpg)

### 1.1.2 如何分层

#### 1.1.1.2 层

1. ODS：原始数据，日志和业务数据
2. DWD：根据数据对象为单位进行分流，比如订单数据，页面访问等  -- kafka
3. DIM：维度数据 -- HBase，phonix
4. DWM：对于部分数据对象进行进一步加工，比如独立访问，跳出行为，也可以和维度进行关联，形成宽表，依旧是明细数据
5. DWS：根据某个主题（维度）将多个事实数据轻度聚合， 形成主题宽表 -- clickhouse
6. ADS：把clickhouse中的数据根据可视化的需求进行筛选聚合  -- 不落盘， 实时接口



## 1.2 整体需求介绍

### 1.2.1 查询的分类

1. 离线查询：需求固定性，每天执行

2. 实时查询：需求固定性，7X24小时执行

3. 即席查询：需求的临时性，临时一次的数据需求，不需要维护。

   - Presto：当场计算（基于内存速度快）

   - kylin：预计算（提前算好），多维度分析（Hive With Cube）
     - sex dept addr => 2的n次方种
       - 0-dim 1
       - 1-dim 3
       - 2-dim 3
       - 3-dim 1

### 1.2.2 实时需求的种类

1. 日常统计报表或分析图中需要包含当日部分
2. 实时数据大屏监控
   - 离线和实时兼并
3. 数据预警提示
   - 只做实时不做离线
4. 实时推荐系统

## 1.3 统计架构分析

### 1.3.1 离线架构

![image-20220707063932326](https://tva1.sinaimg.cn/large/e6c9d24egy1h3xyzfeux9j21ps0u0wlq.jpg)

#### 1.3.1.1 Sqoop导入数据的方式：

1. 全量：where 1=1 
2. 增量：where 创建时间=当天
3. 新增及变化：where 创建时间=当天 or 更新时间=当天
4. 特殊：只导入一次

#### 1.3.1.2 Flume：

1. TailDirSource
   - 优点：断点续传，监控多目录多文件，实时监控
   - 缺点：当文件更名之后会重新读取该文件造成重复
   - 注意：
     1. 要使用不更名打印日志框架（logback）
     1. 修改源码， 让TailDirSource判断文件时只看iNode的值
2. KafkaChannel：
   - 优点：将数据写入kafka，省了一层Sink
   - kafka：生产者，消费者
   - 用法：
     1. source - KafkaChannel - sink
     1. source - KafkaChannel
     1. KafkaChannel - sink
3. 逻辑线：数据流，监控，优化，配置



#### 1.3.1.3 Kafka：

1. Producer：

   - ACK 0  （如何保证生产者不丢数据）
   - 拦截器，序列化器，分区器
   - 发送流程 sender main
   - 幂等性， 事务
   - 分区规则 --> 
     1. 有指定分区则发往指定分区
     2. 没有指定分区，则根据key值hash
     3. 没有指定区分也没有key的时候，轮询（粘性）

2. Broker

   - Topic:
     1. 副本：高可靠
     2. 分区：高并发，负载均衡（防止热点）
     3. 

3. Consumer

   - 分区分配规则

   - offset保存

     1. 默认：__consumer_offsets主题

     2. 其他：手动维护offset（Mysql）， 将保存数据和保存offset写到一个事务，精准一次性

        - 如果不写在同一个事务

          1. 先写数据， 再保存offset： 重复数据+下游幂等性（精准一次消费）

          2. 先写offset， 再写数据：数据可能丢失。

4. 优化，监控，配置，数据量，峰值速度



### 1.3.2 实时架构

![image-20220707070017920](https://tva1.sinaimg.cn/large/e6c9d24egy1h3xzkyg1h9j21pl0u0468.jpg)



### 1.3.3 架构对比

#### 1.3.3.1 离线架构

- 优点：耦合性低，稳定性高
- 缺点：时效性差一点
- 说明：
  1. 项目经理（架构师）决定，更追求稳定性
  2. 耦合性低，稳定性高
  3. 考虑到公司的发展，数据量一定会增长很大
  4. 早期的时候实时业务使用sparkstreming处理（微批次）

#### 1.3.3.2 实时架构

- 优点：时效性高
- 缺点：耦合性高，稳定性低
- 说明：
  1. 时效好
  2. kafka集群高可用，挂一台两台是没有问题
  3. 数据量小，所有机器存在同一个机房，传输没问题
  4. 架构师决定实时业务使用的是Flink



## 1.4 日志数据采集

### 1.4.1 SpringBoot：

 1. Controller：拦截用户请求，调用service，相应请求

 2. Service：调用DAO，加工数据

 3. DAO（Mapper）：获取数据（SQL）

 4. 持久化层：存储数据

    

### 1.4.2 Nginx

1. 正向代理

   正向代理类似一个跳板机，代理访问外部资源。比如：我是一个用户，我访问不了某网

   站，但是我能访问一个代理服务器，这个代理服务器，它能访问那个我不能访问的网站，于

   是我先连上代理服务器，告诉它我需要那个无法访问网站的内容，代理服务器去取回来,然

   后返回给我。

2. 反向代理

   反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然

   后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求

   连接的客户端，此时代理服务器对外就表现为一个反向代理服务器；

3. Nginx的主要作用

   1. 负载均衡

      负载均衡通常是指将请求"均匀"分摊到集群中多个服务器节点上执行，这里的均匀是指

      在一个比较大的统计范围内是基本均匀的，并不是完全均匀， 常用的负载均衡策略：轮询、权重、备机…

      ![image-20220722062409246](https://tva1.sinaimg.cn/large/e6c9d24egy1h4fau0r9rkj215w0eogmk.jpg)

   2. 静态代理

      把所有静态资源的访问改为访问 nginx，而不是访问 tomcat，这种方式叫静态代理。

      因为 nginx 更擅长于静态资源的处理，性能更好，效率更高。

      所以在实际应用中，我们将静态资源比如图片、css、html、js 等交给 nginx 处理，而

      不是由 tomcat 处理

      ![image-20220722062517617](https://tva1.sinaimg.cn/large/e6c9d24egy1h4fav6iwn2j217e0hidhc.jpg)

   3. 动静分离

      Nginx 的负载均衡和静态代理结合在一起，我们可以实现动静分离，这是实际应用中

      常见的一种场景。

      动态资源，如 jsp 由 tomcat 或其他 web 服务器完成

      静态资源，如图片、css、js 等由 nginx 服务器完成

      它们各司其职，专注于做自己擅长的事情

      动静分离充分利用了它们各自的优势，从而达到更高效合理的架构

      ![image-20220722062619354](https://tva1.sinaimg.cn/large/e6c9d24egy1h4faw8x2pcj218q0kamyq.jpg)

   







